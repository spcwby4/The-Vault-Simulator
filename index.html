<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Vault Simulator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    textarea,
    button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    th,
    td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      word-wrap: break-word;
      font-size: 14px;
    }
    th {
      background-color: #eee;
    }
    .hidden {
      display: none;
    }
    .matrix-section {
      margin-top: 10px;
    }
    .collapsible {
      cursor: pointer;
      background-color: #eee;
      border: none;
      padding: 10px;
      width: 100%;
      text-align: left;
      font-weight: bold;
    }
    .collapsible:after {
      content: ' ▼';
    }
    .active:after {
      content: ' ▲';
    }
    .content {
      display: none;
      overflow: hidden;
    }
    .jury-total {
      font-weight: bold;
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>The Vault Simulator</h1>
  <div class="container">
    <div>
      <div class="card">
        <h2>Enter 12 Player Names (1 per line)</h2>
        <textarea id="playerInput" rows="13" placeholder="Enter 12 players..."></textarea>
        <button id="startBtn" onclick="startGame()">Start Game</button>
        <button id="nextBtn" class="hidden" onclick="nextRound()">Next Round</button>
      </div>

      <div class="card">
        <h2>Round Events</h2>
        <div id="eventLog" style="white-space: pre-line;"></div>
      </div>

      <div class="card hidden" id="votingMatrixBox">
        <h2>Voting Matrix</h2>
        <div id="votingMatrix"></div>
      </div>

      <div class="card hidden" id="juryMatrixBox">
        <h2>Jury Key Distribution</h2>
        <div id="juryMatrix"></div>
      </div>

      <div class="card hidden" id="progressChartBox">
        <h2>Progress Chart</h2>
        <div id="progressChart"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>Alliances</h2>
        <div id="alliancesDisplay"></div>
      </div>
    </div>
  </div>

  <!-- SCRIPT STARTS BELOW -->
  <script>
  let players = [], activePlayers = [], eliminatedPlayers = [], jurors = [], finalists = [];
let lockpickHolder = null, lockpickHidden = true;
let alliances = [], phase = 1, round = 1;
let voteLogs = [], vaultChoices = {};
const vaults = [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];

function startGame() {
  const input = document.getElementById("playerInput").value.trim().split("\n").map(p => p.trim()).filter(Boolean);
  if (input.length !== 12) return alert("You must enter exactly 12 players.");
  players = input.map(name => ({ name, keys: 0, eliminated: false, alliances: [], phase: null }));
  activePlayers = [...players];
  generateAlliances();
  document.getElementById("playerInput").classList.add("hidden");
  document.getElementById("startBtn").classList.add("hidden");
  document.getElementById("nextBtn").classList.remove("hidden");
  log(`Phase 1: Key Quest begins!`);
  updateProgressChart();
}

function generateAlliances() {
  alliances = [
    { name: "Alliance Alpha", members: players.slice(0, 4) },
    { name: "Alliance Bravo", members: players.slice(4, 8) },
    { name: "Alliance Chaos", members: players.slice(8, 12) }
  ];
  alliances.forEach(a => a.members.forEach(p => p.alliances.push(a.name)));
  const box = document.getElementById("alliancesDisplay");
  box.innerHTML = "";
  alliances.forEach(a => {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${a.name}:</strong> ${a.members.map(p => p.name).join(", ")}`;
    box.appendChild(div);
  });
}

function nextRound() {
  clearLog();
  if (phase === 1) simulatePhase1();
  else if (phase === 2) simulatePhase2();
  else if (phase === 3) simulatePhase3();
  else simulateFinale();
}

function simulatePhase1() {
  log(`Phase 1 - Round ${round}`);
  const eligible = activePlayers.filter(p => p.keys === 0);
  const drawn = round === 4 ? eligible : randomSample(eligible, 4);
  drawn.forEach(p => log(`${p.name} is drawn.`));

  if (lockpickHidden && Math.random() < 0.33) {
    const finder = randomPick(drawn);
    lockpickHolder = finder;
    lockpickHidden = false;
    log(`${finder.name} secretly found the Lockpick.`);
  }

  let voteTarget = randomPick(drawn);
  let votes = players.map(voter => {
    let options = drawn.filter(p => p.name !== voter.name);
    return { voter: voter.name, vote: randomPick(options).name };
  });

  let counts = {};
  votes.forEach(v => counts[v.vote] = (counts[v.vote] || 0) + 1);
  let maxVotes = Math.max(...Object.values(counts));
  let tied = Object.keys(counts).filter(k => counts[k] === maxVotes);
  voteTarget = drawn.find(p => p.name === randomPick(tied));

  if (lockpickHolder && drawn.includes(lockpickHolder)) {
    voteTarget = lockpickHolder;
    log(`${lockpickHolder.name} uses the Lockpick to override the vote!`);
    lockpickHolder = null;
    lockpickHidden = true;
  }

  voteTarget.keys++; voteTarget.phase = 1;
  log(`${voteTarget.name} wins the vote key!`);
  const challengeWinner = randomPick(drawn.filter(p => p !== voteTarget));
  challengeWinner.keys++; challengeWinner.phase = 1;
  log(`${challengeWinner.name} wins the challenge key!`);

  voteLogs.push({ phase: 1, round, voters: players.map(p => p.name), votes });
  displayVotingMatrix();

  round++;
  updateProgressChart();

  if (round > 4) {
    const eliminated = activePlayers.filter(p => p.keys === 0);
    eliminated.forEach(p => { p.eliminated = true; jurors.push(p); eliminatedPlayers.push(p); log(`${p.name} is eliminated in Phase 1.`); });
    activePlayers = activePlayers.filter(p => p.keys > 0);
    phase = 2; round = 1;
    log(`Phase 2: Key Duels begins!`);
  }
}

function simulatePhase2() {
  log(`Phase 2 - Round ${round}`);
  const noKey = activePlayers.filter(p => p.phase !== 2);
  if (noKey.length < 2) return phase = 3, round = 1, log("Only one player left without a key. Advancing to Phase 3.");

  if (lockpickHidden && Math.random() < 0.33) {
    const finder = randomPick(noKey);
    lockpickHolder = finder;
    lockpickHidden = false;
    log(`${finder.name} secretly found the Lockpick.`);
  }

  let voteTarget = randomPick(noKey);
  let votes = activePlayers.map(voter => {
    let options = noKey.filter(p => p.name !== voter.name);
    return { voter: voter.name, vote: randomPick(options).name };
  });

  let counts = {};
  votes.forEach(v => counts[v.vote] = (counts[v.vote] || 0) + 1);
  let maxVotes = Math.max(...Object.values(counts));
  let tied = Object.keys(counts).filter(k => counts[k] === maxVotes);
  voteTarget = noKey.find(p => p.name === randomPick(tied));

  if (lockpickHolder && noKey.includes(lockpickHolder)) {
    voteTarget = lockpickHolder;
    log(`${lockpickHolder.name} uses the Lockpick to override the vote!`);
    lockpickHolder = null;
    lockpickHidden = true;
  }

  const opponent = randomPick(noKey.filter(p => p !== voteTarget));
  log(`${voteTarget.name} duels ${opponent.name}.`);
  const winner = Math.random() < 0.5 ? voteTarget : opponent;
  winner.keys++; winner.phase = 2;
  log(`${winner.name} wins the duel and earns a key!`);

  voteLogs.push({ phase: 2, round, voters: activePlayers.map(p => p.name), votes });
  displayVotingMatrix();

  round++;
  updateProgressChart();

  if (round > 4) {
    const eliminated = activePlayers.filter(p => p.phase !== 2);
    eliminated.forEach(p => { p.eliminated = true; jurors.push(p); eliminatedPlayers.push(p); log(`${p.name} is eliminated in Phase 2.`); });
    activePlayers = activePlayers.filter(p => p.phase === 2);
    phase = 3; round = 1;
    log("Phase 3: Final Cut begins!");
  }
}

function simulatePhase3() {
  log("Phase 3: Final 4");
  const voteWinner = randomPick(activePlayers);
  const chosen = randomPick(activePlayers.filter(p => p !== voteWinner));
  const remaining = activePlayers.filter(p => ![voteWinner.name, chosen.name].includes(p.name));
  const challengeWinner = Math.random() < 0.5 ? remaining[0] : remaining[1];
  const fourth = remaining.find(p => p !== challengeWinner);
  fourth.eliminated = true; jurors.push(fourth); eliminatedPlayers.push(fourth);
  finalists = [voteWinner, chosen, challengeWinner];
  finalists.forEach(p => { p.phase = 3; p.keys++; });

  log(`${voteWinner.name} wins the vote and chooses ${chosen.name}.`);
  log(`${remaining[0].name} vs ${remaining[1].name}. ${challengeWinner.name} wins the final challenge!`);
  log(`${fourth.name} is eliminated in 4th place.`);

  voteLogs.push({
    phase: 3,
    round,
    voters: activePlayers.map(p => p.name),
    votes: activePlayers.map(voter => {
      let options = activePlayers.filter(p => p.name !== voter.name);
      return { voter: voter.name, vote: randomPick(options).name };
    })
  });
  displayVotingMatrix();
  updateProgressChart();
  phase = 4;
}

function simulateFinale() {
  log("Vault Finale Begins!");
  const matrix = {}, totals = {};
  jurors.forEach(j => {
    const keys = j.phase === 1 ? 1 : j.phase === 2 ? 2 : 4;
    matrix[j.name] = {}; totals[j.name] = 0;
    const distribution = randomSample(finalists, keys);
    distribution.forEach(f => {
      matrix[j.name][f.name] = (matrix[j.name][f.name] || 0) + 1;
      f.keys++; totals[j.name]++;
    });
  });

  displayJuryMatrix(matrix, totals);

  finalists.forEach(f => {
    const vault = vaults.filter(v => v <= f.keys).reverse()[0] || 3;
    vaultChoices[f.name] = vault;
  });

  let winner = null, highest = 0;
  finalists.forEach(f => {
    const required = vaultChoices[f.name];
    if (f.keys >= required && required > highest) {
      winner = f;
      highest = required;
    }
  });

  winner ? log(`${winner.name} opens the ${highest}-key vault and wins The Vault!`) :
    log(`No one opened a vault. ${eliminatedPlayers.find(p => p.phase === 3).name} wins by default.`);

  document.getElementById("nextBtn").textContent = "Simulate Again";
  document.getElementById("nextBtn").onclick = () => location.reload();
}

function displayVotingMatrix() {
  const container = document.getElementById("votingMatrix");
  container.innerHTML = "";
  voteLogs.forEach((logEntry) => {
    const btn = document.createElement("button");
    btn.className = "collapsible";
    btn.textContent = `Phase ${logEntry.phase}, Round ${logEntry.round} Voting`;
    const content = document.createElement("div");
    content.className = "content";
    const table = document.createElement("table");
    table.innerHTML = "<tr><th>Voter</th><th>Voted For</th></tr>";
    logEntry.votes.forEach(v => {
      const row = `<tr><td>${v.voter}</td><td>${v.vote}</td></tr>`;
      table.innerHTML += row;
    });
    content.appendChild(table);
    btn.onclick = function () {
      this.classList.toggle("active");
      content.style.display = content.style.display === "block" ? "none" : "block";
    };
    container.appendChild(btn);
    container.appendChild(content);
  });
  document.getElementById("votingMatrixBox").classList.remove("hidden");
}

function displayJuryMatrix(matrix, totals) {
  const box = document.getElementById("juryMatrix");
  box.innerHTML = "";
  const table = document.createElement("table");
  let header = "<tr><th>Juror</th>";
  finalists.forEach(f => header += `<th>${f.name}</th>`);
  header += "<th>Total</th></tr>";
  table.innerHTML += header;
  for (const juror in matrix) {
    let row = `<tr><td>${juror}</td>`;
    let rowTotal = 0;
    finalists.forEach(f => {
      const val = matrix[juror][f.name] || 0;
      row += `<td>${val}</td>`;
      rowTotal += val;
    });
    row += `<td class="jury-total">${rowTotal}</td></tr>`;
    table.innerHTML += row;
  }
  box.appendChild(table);
  document.getElementById("juryMatrixBox").classList.remove("hidden");
}

function updateProgressChart() {
  const chart = document.getElementById("progressChart");
  chart.innerHTML = "";
  const table = document.createElement("table");
  table.innerHTML = "<tr><th>Player</th><th>Phase 1</th><th>Phase 2</th><th>Phase 3</th></tr>";
  players.forEach(p => {
    const row = document.createElement("tr");
    const p1 = p.phase >= 1 ? "✅" : "";
    const p2 = p.phase >= 2 ? "✅" : "";
    const p3 = p.phase >= 3 ? "✅" : "";
    row.innerHTML = `<td>${p.name}</td><td>${p1}</td><td>${p2}</td><td>${p3}</td>`;
    table.appendChild(row);
  });
  chart.appendChild(table);
  document.getElementById("progressChartBox").classList.remove("hidden");
}

function log(msg) {
  document.getElementById("eventLog").innerText += msg + "\n";
}
function clearLog() {
  document.getElementById("eventLog").innerText = "";
}
function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}
function randomSample(arr, n) {
  const copy = [...arr];
  const res = [];
  while (res.length < n && copy.length) {
    const index = Math.floor(Math.random() * copy.length);
    res.push(copy.splice(index, 1)[0]);
  }
  return res;
}
</script>
</body>
</html>